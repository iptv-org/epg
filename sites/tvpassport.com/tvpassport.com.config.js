const axios = require('axios')
const dayjs = require('dayjs')
const cheerio = require('cheerio')
const utc = require('dayjs/plugin/utc')
const timezone = require('dayjs/plugin/timezone')
const customParseFormat = require('dayjs/plugin/customParseFormat')
const doFetch = require('@ntlab/sfetch')

dayjs.extend(utc)
dayjs.extend(timezone)
dayjs.extend(customParseFormat)

/**
 * Because there is no way to determine the language of the channel from the website, we need to hardcode the French channels.
 */
const FRENCH_CHANNELS = new Set([
  'addik-tv-hd/6059',
  'addik-tv/2033',
  'artv-hd/5887',
  'artv/459',
  'canal-d-hd/3978',
  'canal-d-sur-demande/10895',
  'canal-d/108',
  'canal-vie-hd/3974',
  'canal-vie-sur-demande/10897',
  'canal-vie/307',
  'casa-hd/10211',
  'casa-sur-demande/10361',
  'casa/5484',
  'evasion-hd/6468',
  'evasion-sur-demande/9057',
  'evasion-sur-demande/31477',
  'evasion/343',
  'explora-hd/10299',
  'explora/10298',
  'historia-dv/8390',
  'historia-hd/3976',
  'historia-sur-demande/10899',
  'historia/345',
  'ici-television-cfhd-dt-montreal-qc-hd/13786',
  'ici-television-cfhd-dt-montreal-qc/11385',
  'ici-television-cfhd-dt-montreal-qc/26780',
  'ici-television-quebec-hd/32137',
  'ici-television-quebec/32134',
  'lcn-hd/7321',
  'lcn/432',
  'prise-2-hd/10848',
  'prise-2-sur-demande/10768',
  'prise-2/2848',
  'rdi-news-hd/5888',
  'rdi-news/8',
  'rds-2-hd/9970',
  'rds-2/9705',
  'rds-info-hd/10849',
  'rds-info/3889',
  'rds-reseau-des-sports-hd/5582',
  'rds-reseau-des-sports/47',
  'ici-cbaft-moncton-nb-hd/6816',
  'ici-cbaft-moncton-nb/118',
  'ici-cbeft-windsor/3883',
  'ici-cbfj-st-johns-nf-hd/6818',
  'ici-cbfj-st-johns-nf/5476',
  'ici-cbfst-src-nord-qc-hd/9671',
  'ici-cbfst-src-nord/598',
  'ici-cbft-montreal-qc-dv/5935',
  'ici-cbft-montreal-qc-hd/2837',
  'ici-cbft-montreal-qc/196',
  'ici-cbgat-gaspe-qc-hd/9670',
  'ici-cbgat-gaspe-qc/2167',
  'ici-cbhft-halifax-ns-hd/6817',
  'ici-cbhft-halifax-ns/3882',
  'ici-cbkft-regina-sk-hd/6819',
  'ici-cbkft-regina-sk/287',
  'ici-cblft-toronto-hd/3626',
  'ici-cblft-toronto/14',
  'ici-cboft-ottawa-on-dv/14158',
  'ici-cboft-ottawa-on-hd/6768',
  'ici-cboft-ottawa-on/463',
  'ici-cbrft-calgary-ab-dv/14160',
  'ici-cbrft-calgary-ab-hd/9610',
  'ici-cbrft-calgary-ab/3980',
  'ici-cbst-sept-iles-qc-hd/9673',
  'ici-cbst-sept-iles-qc/3299',
  'ici-cbuft-vancouver-bc-hd/6769',
  'ici-cbuft-vancouver-bc/188',
  'ici-cbvt-quebec-qc--digital/5948',
  'ici-cbvt-quebec-qc-hd/6820',
  'ici-cbvt-quebec-qc/562',
  'ici-cbwft-winnipeg-mb-hd/6770',
  'ici-cbwft-winnipeg-mb/144',
  'ici-cbxft-edmonton-ab-dv/14159',
  'ici-cbxft-edmonton-ab-hd/9609',
  'ici-cbxft-edmonton-ab/174',
  'ici-cjbr-rimouski-qc-hd/9668',
  'ici-cjbr-rimouski-qc/2170',
  'ici-cjdg-dt-val-dor-qc/14060',
  'ici-cjdg-tv-2-lebel-sur-quevillon-qc/14062',
  'ici-cjdg-tv-3-joutel-qc/14064',
  'ici-cjdg-tv-4-matagami-qc-hd/14067',
  'ici-cjdg-tv-4-matagami-qc/14066',
  'ici-ckrn-rouyn-qc-hd/9669',
  'ici-ckrn-rouyn-qc/1036',
  'ici-ckrn-tv-2-ville-marie-qc/14056',
  'ici-ckrn-tv-3-bearnfabre-qc/14058',
  'ici-ckrt-dt-1-baie-st-paul-qc/14050',
  'ici-ckrt-dt-2-degelis-qc/14051',
  'ici-ckrt-dt-3-riviere-du-loup-qc/14052',
  'ici-ckrt-dt-4-cabano-qc/14053',
  'ici-ckrt-dt-5-st-urbain-qc/14054',
  'ici-ckrt-dt-6-trois-pistoles-qc/14055',
  'ici-ckrt-riviere-du-loup-qc-hd/10928',
  'ici-ckrt-riviere-du-loup-qc/499',
  'ici-cksh-sherbrooke-qc--digital/5936',
  'ici-cksh-sherbrooke-qc-hd/9672',
  'ici-cksh-sherbrooke-qc/2169',
  'ici-cktm-trois-rivieres-qc--digital/5946',
  'ici-cktm-trois-rivieres-qc-hd/9674',
  'ici-cktm-trois-rivieres-qc/550',
  'ici-cktv-jonquiere-qc-hd/10968',
  'ici-cktv-jonquiere-qc/606',
  'ici-cktv-saguenay-qc-hd/9667',
  'ici-cktv-saguenay-qc/564',
  'ici-explora-sur-demand/10767',
  'ici-musique-montreal-1007-cbfx/37551',
  'ici-musique-rimouski-1015-cbrx/35693',
  'ici-musique-trois-rivieres-1043-cbfm/35679',
  'ici-premiere-gaspesie-893-cbga/37527',
  'ici-premiere-montreal-951-cbf/35702',
  'ici-premiere-rimouski-891-cjbr/35692',
  'ici-premiere-saguenay-937-cbj/37534',
  'ici-premiere-sept-iles-981-cbsi/37530',
  'ici-premiere-sherbrooke-1011-cbf/35703',
  'ici-premiere-trois-rivieres-881-cbf/35691',
  'ici-radio-canada-sur-demand/9059',
  'ici-television-cfhd-dt-montreal-qc-hd/13786',
  'ici-television-cfhd-dt-montreal-qc/11385',
  'ici-television-cfhd-dt-montreal-qc/26780',
  'ici-television-quebec-hd/32137',
  'ici-television-quebec/32134',
  'super-ecran-2-hd/8459',
  'super-ecran-2/362',
  'super-ecran-3-hd/9822',
  'super-ecran-3/410',
  'super-ecran-4-hd/9825',
  'super-ecran-4/411',
  'super-ecran-hd-1/5898',
  'super-ecran-sur-demande/3426',
  'super-ecran/57',
  'tva-cfcm-quebec--digital/5931',
  'tva-cfcm-quebec-hd/11116',
  'tva-cfcm-quebec/1031',
  'tva-cfem-rouyn-hd/15399',
  'tva-cfem-rouyn/2540',
  'tva-cfer-rimouski-hd/31497',
  'tva-cfer-rimouski/1034',
  'tva-cftm-montreal-hd/5934',
  'tva-cftm-montreal/106',
  'tva-cftm-west-feed-hd/32777',
  'tva-cftm-west-feed/1753',
  'tva-chau-carleton-hd/9976',
  'tva-chau-carleton/141',
  'tva-chau-dt-1-ste-marguerite-marie-qc/13903',
  'tva-chau-dt-2-st-quentin-nb/13906',
  'tva-chau-dt-3-port-daniel-qc/13907',
  'tva-chau-dt-4-chandler-qc/13908',
  'tva-chau-dt-6-gaspe-qc/13909',
  'tva-chau-dt-7-riviere-au-renard-qc',
  'tva-chau-dt-8-cloridorme-qc',
  'tva-chau-dt-9-lanse-a-valleau-qc/13912',
  'tva-chau-dt-10-tracadie-nb/13904',
  'tva-chau-dt-11-kedgwick-nb/13905',
  'tva-chau-dt-51-perce-qc/13902',
  'tva-chem-trois-rivieres-mauricie-hd/11118',
  'tva-chem-trois-rivieres/1033',
  'tva-chem-trois-riviers--digital/5933',
  'tva-chlt-sherbrooke--digital/5932',
  'tva-chlt-sherbrooke-hd/11117',
  'tva-chlt-sherbrooke/1032',
  'tva-chot-gatineau-qc-hd/31494',
  'tva-chot-gatineau-qc/4',
  'tva-cimt-dt-1-edmundston-nb/14069',
  'tva-cimt-dt-2-trois-pistoles-qc/14070',
  'tva-cimt-dt-4-baie-st-paul-qc/14071',
  'tva-cimt-dt-5-st-urbain-qc/14072',
  'tva-cimt-dt-6-riviere-du-loup-qc/14073',
  'tva-cimt-dt-7-les-escoumins-qc/14074',
  'tva-cimt-dt-8-cabano-qc/14075',
  'tva-cimt-riviere-du-loup-hd/31589',
  'tva-cimt-riviere-du-loup/317',
  'tva-cjpm-saguenay-chicoutimi-qc-hd/31496',
  'tva-cjpm-saguenay-qc/1035',
  'tva-hd/4354',
  'tva-sports-2-hd/13778',
  'tva-sports-2/13777',
  'tva-sports-3-hd/15116',
  'tva-sports-3/14946',
  'tva-sports-hd/9824',
  'tva-sports/9823',
  'noovo-cfap-quebec-qc-hd/5937',
  'noovo-cfap-quebec-qc/2179',
  'noovo-cfgs-gatineau-qc-hd/31506',
  'noovo-cfgs-gatineau-qc/5',
  'noovo-cfjp-montreal-qc/301',
  'noovo-cfjp-montrealqc-hd/5940',
  'noovo-cfkm-trois-rivieres-qc-hd/5938',
  'noovo-cfkm-trois-rivieres-qc/2180',
  'noovo-cfks-sherbrooke-qc-hd/5939',
  'noovo-cfks-sherbrooke-qc/2181',
  'noovo-cfrs-saguenaylac-st-jean-qc-hd/31495',
  'noovo-cfrs-saguenaylac-st-jean-qc/2183',
  'noovo-cftf-dt-1-edmundston-nb/13995',
  'noovo-cftf-dt-2-trois-pistoles-qc/13998',
  'noovo-cftf-dt-3-cabano-qc/13999',
  'noovo-cftf-dt-4-forestville-qc/14000',
  'noovo-cftf-dt-5-baie-comeau-qc/14001',
  'noovo-cftf-dt-6-riviere-du-loup-qc/14002',
  'noovo-cftf-dt-7-sept-iles-qc/14003',
  'noovo-cftf-dt-8-les-escoumins-qc/14004',
  'noovo-cftf-dt-9-gaspe-qc/14005',
  'noovo-cftf-dt-10-baie-st-paul-qc/13996',
  'noovo-cftf-dt-11-carleton-qc/13997',
  'noovo-cftf-riviere-du-loup-qc/1272',
  'noovo-cfvs-dt-1-rouyn-noranda-qc/14008',
  'noovo-cfvs-val-dor-qc/2184',
  'noovo-cjpc-dt-rimouski-qc/13994',
  'noovo-hd/4884',
  'series--dv/8394',
  'series--hd/3975',
  'series--sur-demande/10898',
  'series-/341',
  'z-dv/8402',
  'z-hd/3979',
  'zeste-hd/7943',
  'zeste/7508',
  'zeste-sur-demande/9058',
  'qub/7616',
  'qub-hd/7617',
  'tele-quebec-civa-dt-1-rouyn-noranda-qc/14082',
  'tele-quebec-civa-val-dor-hd/6458',
  'tele-quebec-civa-val-dor/1134',
  'tele-quebec-civb-dt-1-grand-fonds-qc/14083',
  'tele-quebec-civb-rimouski-hd/6459',
  'tele-quebec-civb-rimouski/1135',
  'tele-quebec-civc-trois-rivieres-hd/6460',
  'tele-quebec-civc-trois-rivieres/1136',
  'tele-quebec-civf-baie-trinite-hd/6461',
  'tele-quebec-civf-baie-trinite/1137',
  'tele-quebec-civg-sept-iles-hd/6462',
  'tele-quebec-civg-sept-iles/1138',
  'tele-quebec-civk-carleton-hd/6463',
  'tele-quebec-civk-carleton/1139',
  'tele-quebec-civk-dt-1-gascons-qc/14078',
  'tele-quebec-civk-dt-2-perce-qc/14076',
  'tele-quebec-civk-dt-3-gaspe-qc/14077',
  'tele-quebec-civm-montreal-hd/6464',
  'tele-quebec-civm-montreal/1140',
  'tele-quebec-civo-hull-hd/6465',
  'tele-quebec-civo-hull/1141',
  'tele-quebec-civp-chapeau/1142',
  'tele-quebec-civq-quebec-hd/6466',
  'tele-quebec-civq-quebec/1058',
  'tele-quebec-civs-sherbrooke-hd/5951',
  'tele-quebec-civs-sherbrooke/52',
  'tele-quebec-civv-chicoutimi-hd/6467',
  'tele-quebec-civv-chicoutimi/1143',
  'telemagino/8019',
  'temoin-hd/9155',
  'temoin-sur-demande/10360',
  'temoin/9109',
  'investigation-hd/11345',
  'investigation-sur-demande/15115',
  'investigation/11344',
  'assemblee-nationale-du-quebec/431',
  'elle-fictions-hd/9111',
  'elle-fictions/101',
  'frissons-tv-hd/32126',
  'frissons-tv/32125',
  'max-hd/9112',
  'max/306',
  'cinepop-hd/9156',
  'cinepop/2325'
])

module.exports = {
  site: 'tvpassport.com',
  days: 3,
  url({ channel, date }) {
    return `https://www.tvpassport.com/tv-listings/stations/${channel.site_id}/${date.format(
      'YYYY-MM-DD'
    )}`
  },
  request: {
    timeout: 30000,
    headers: {
      Cookie: 'cisession=e49ff13191d6875887193cae9e324b44ef85768d;'
    }
  },
  parser: function ({ content }) {
    let programs = []
    const items = parseItems(content)
    for (let item of items) {
      const $item = cheerio.load(item)
      const start = parseStart($item)
      const duration = parseDuration($item)
      const stop = start.add(duration, 'm')
      let title = parseTitle($item)
      let subtitle = parseSubTitle($item)
      if (title === 'Movie') {
        title = subtitle
        subtitle = null
      }

      programs.push({
        title,
        subtitle,
        description: parseDescription($item),
        image: parseImage($item),
        category: parseCategory($item),
        rating: parseRating($item),
        actors: parseActors($item),
        guest: parseGuest($item),
        director: parseDirector($item),
        year: parseYear($item),
        start,
        stop
      })
    }

    return programs
  },
  async channels() {
    function wait(ms) {
      return new Promise(resolve => {
        setTimeout(resolve, ms)
      })
    }

    const xml = await axios
      .get('https://www.tvpassport.com/sitemap.stations.xml')
      .then(r => r.data)
      .catch(console.error)

    const $ = cheerio.load(xml)

    const elements = $('loc').toArray()
    const queue = elements.map(el => $(el).text())
    const total = queue.length

    let i = 1
    const channels = []

    await doFetch(queue, async (url, res) => {
      if (!res) return

      const [, site_id] = url.match(/\/tv-listings\/stations\/(.*)$/)

      console.log(`[${i}/${total}]`, url)

      await wait(1000)

      const $channelPage = cheerio.load(res)
      const title = $channelPage('meta[property="og:title"]').attr('content')
      const name = title.replace('TV Schedule for ', '')
      const lang = FRENCH_CHANNELS.has(site_id) ? 'fr' : 'en'

      console.log(site_id, lang)

      channels.push({
        lang,
        site_id,
        name
      })

      i++
    })

    return channels
  }
}

function parseDescription($item) {
  return $item('*').data('description')
}

function parseImage($item) {
  const showpicture = $item('*').data('showpicture')
  const url = new URL(showpicture, 'https://cdn.tvpassport.com/image/show/960x540/')

  return url.href
}

function parseTitle($item) {
  return $item('*').data('showname').toString()
}

function parseSubTitle($item) {
  return $item('*').data('episodetitle').toString() || null
}

function parseYear($item) {
  return $item('*').data('year').toString() || null
}

function parseCategory($item) {
  const showtype = $item('*').data('showtype')

  return showtype ? showtype.split(', ') : []
}

function parseActors($item) {
  const cast = $item('*').data('cast')

  return cast ? cast.split(', ') : []
}

function parseDirector($item) {
  const director = $item('*').data('director')

  return director ? director.split(', ') : []
}

function parseGuest($item) {
  const guest = $item('*').data('guest')

  return guest ? guest.split(', ') : []
}

function parseRating($item) {
  const rating = $item('*').data('rating')

  return rating
    ? {
        system: 'MPA',
        value: rating.replace(/^TV/, 'TV-')
      }
    : null
}

function parseStart($item) {
  const time = $item('*').data('st')

  return dayjs.tz(time, 'YYYY-MM-DD HH:mm:ss', 'America/New_York')
}

function parseDuration($item) {
  const duration = $item('*').data('duration')

  return parseInt(duration)
}

function parseItems(content) {
  if (!content) return []
  const $ = cheerio.load(content)

  return $('.station-listings .list-group-item').toArray()
}
